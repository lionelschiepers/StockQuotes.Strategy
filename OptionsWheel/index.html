<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Analysis Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.js"></script>
    <style>
        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: #3b82f6 !important;
            color: white !important;
            border: 1px solid #3b82f6 !important;
        }
        table.dataTable thead th {
            border-bottom: 2px solid #e5e7eb !important;
        }
        table.dataTable border-collapse: collapse;
    </style>
</head>
<body class="bg-gray-50 p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">Stock Analysis Dashboard</h1>
            <p id="last-updated" class="text-gray-500 mt-2">Loading data...</p>
        </header>
        
        <!-- Summary Cards -->
        <div id="summary" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 animate-pulse h-24"></div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 animate-pulse h-24"></div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 animate-pulse h-24"></div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 animate-pulse h-24"></div>
        </div>

        <!-- Main Table -->
        <div class="bg-white p-6 rounded-xl shadow-md border border-gray-100 overflow-hidden">
            <table id="resultsTable" class="display w-full text-sm">
                <thead>
                    <tr class="text-left bg-gray-50">
                        <th class="px-4 py-3 font-semibold text-gray-700">Symbol</th>
                        <th class="px-4 py-3 font-semibold text-gray-700">Name</th>
                        <th class="px-4 py-3 font-semibold text-gray-700">Status</th>
                        <th class="px-4 py-3 font-semibold text-gray-700">Price</th>
                        <th class="px-4 py-3 font-semibold text-gray-700">EMA50</th>
                        <th class="px-4 py-3 font-semibold text-gray-700">Diff%</th>
                        <th class="px-4 py-3 font-semibold text-gray-700">ADX</th>
                        <th class="px-4 py-3 font-semibold text-gray-700">RSI</th>
                        <th class="px-4 py-3 font-semibold text-gray-700">RVI</th>
                        <th class="px-4 py-3 font-semibold text-gray-700">MACD</th>
                        <th class="px-4 py-3 font-semibold text-gray-700">Failed Criterion</th>
                        <th class="px-4 py-3 font-semibold text-gray-700">Put Option</th>
                    </tr>
                </thead>
                <tbody id="tableBody" class="divide-y divide-gray-200">
                    <!-- Data will be injected here -->
                </tbody>
            </table>
        </div>
        
        <footer class="mt-8 text-center text-gray-400 text-xs">
            Generated by OptionsWheel Strategy Analyzer
        </footer>
    </div>

    <script>
        $(document).ready(function() {
            fetch('analysis_results.json')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    // Update Last Updated
                    const date = new Date(data.timestamp);
                    document.getElementById('last-updated').innerText = `Last analyzed: ${date.toLocaleString()}`;

                    // Update Summary
                    const summaryDiv = document.getElementById('summary');
                    const cards = [
                        { label: 'Analyzed', value: data.total_tickers_analyzed, color: 'blue' },
                        { label: 'Phase 1 Passed', value: data.candidates_after_phase1, color: 'indigo' },
                        { label: 'Passed All', value: data.passed_all_criteria, color: 'green' },
                        { label: 'Near Misses', value: data.near_misses, color: 'amber' }
                    ];
                    
                    summaryDiv.innerHTML = cards.map(card => `
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                            <p class="text-gray-400 text-xs font-bold uppercase tracking-wider">${card.label}</p>
                            <p class="text-3xl font-black text-gray-800 mt-1">${card.value.toLocaleString()}</p>
                            <div class="h-1 w-12 bg-${card.color}-500 mt-3 rounded-full"></div>
                        </div>
                    `).join('');

                    // Populate Table
                    const tableBody = document.getElementById('tableBody');
                    tableBody.innerHTML = data.results.map(r => `
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-4 py-4 font-bold text-blue-600">${r.Symbol}</td>
                            <td class="px-4 py-4 text-gray-600 max-w-xs truncate" title="${r.Name}">${r.Name}</td>
                            <td class="px-4 py-4">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${r.Status === 'PASS' ? 'bg-green-100 text-green-800' : 'bg-amber-100 text-amber-800'}">
                                    ${r.Status}
                                </span>
                            </td>
                            <td class="px-4 py-4 font-mono text-gray-700 font-medium">${r.Price.toFixed(2)}</td>
                            <td class="px-4 py-4 font-mono text-gray-500">${r.EMA50.toFixed(2)}</td>
                            <td class="px-4 py-4 font-mono font-bold ${r.DiffPct < 0 ? 'text-red-500' : 'text-emerald-500'}">
                                ${r.DiffPct > 0 ? '+' : ''}${r.DiffPct.toFixed(2)}%
                            </td>
                            <td class="px-4 py-4 text-gray-600">${r.ADX.toFixed(2)}</td>
                            <td class="px-4 py-4 text-gray-600">${r.RSI.toFixed(2)}</td>
                            <td class="px-4 py-4 text-gray-600">${r.RVI.toFixed(2)}</td>
                            <td class="px-4 py-4 text-gray-600">${r.MACD.toFixed(2)}</td>
                            <td class="px-4 py-4 text-xs text-gray-400 italic">${r['Failed Criterion'] || '<span class="text-gray-200">—</span>'}</td>
                            <td class="px-4 py-4 put-option-cell" data-symbol="${r.Symbol}" data-price="${r.Price}">
                                <span class="text-gray-400">Loading...</span>
                            </td>
                        </tr>
                    `).join('');

                    // Initialize DataTable
                    const table = $('#resultsTable').DataTable({
                        pageLength: 25,
                        order: [[2, 'asc'], [5, 'asc']], // Default sort: Status then DiffPct
                        responsive: true,
                        columnDefs: [
                            { targets: 11, orderable: false }
                        ],
                        language: {
                            searchPlaceholder: "Search tickers...",
                            search: ""
                        }
                    });
                    
                    // Style the search box
                    $('.dataTables_filter input').addClass('bg-gray-50 border border-gray-200 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4');

                    // Fetch put options on draw (sort, filter, page change)
                    table.on('draw', function() {
                        const visibleCells = document.querySelectorAll('.put-option-cell');
                        const visibleRows = [];
                        visibleCells.forEach(cell => {
                            const symbol = cell.dataset.symbol;
                            const row = data.results.find(r => r.Symbol === symbol);
                            if (row) visibleRows.push(row);
                        });
                        checkPutOptions(visibleRows);
                    });

                    // Initial fetch
                    checkPutOptions(data.results);
                })
                .catch(error => {
                    console.error('Error loading JSON:', error);
                    document.getElementById('summary').innerHTML = `
                        <div class="col-span-full bg-red-50 p-4 border border-red-200 rounded-lg text-red-700">
                            <strong>Error:</strong> Could not load analysis results. 
                            <p class="text-sm mt-1">Please ensure <code>analysis_results.json</code> exists and you are viewing this page through a web server (e.g., <code>python -m http.server</code>).</p>
                        </div>
                    `;
                });
                });

        async function fetchWithRetry(url, maxRetries = 3, baseDelay = 1000) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                const response = await fetch(url);
                if (response.ok) return response;
                if (response.status === 429) {
                    const retryAfter = response.headers.get('Retry-After');
                    let delay;
                    if (retryAfter) {
                        const seconds = parseInt(retryAfter, 10);
                        delay = isNaN(seconds) ? baseDelay * Math.pow(2, attempt) : seconds * 1000;
                    } else {
                        delay = baseDelay * Math.pow(2, attempt);
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    continue;
                }
                throw new Error(`HTTP ${response.status}`);
            }
            throw new Error('Max retries exceeded');
        }

        async function checkSinglePutOption(r, optionsApiUrl) {
            const cell = document.querySelector(`.put-option-cell[data-symbol="${r.Symbol}"]`);
            if (!cell) return;
            
            try {
                const response = await fetchWithRetry(optionsApiUrl.replace('{TICKER}', r.Symbol));
                const data = await response.json();
                
                const price = r.Price;
                const targetStrike = price * 0.93;
                
                const options = data.options || [];

                const puts1 = Array.isArray(options) && options.length > 0 ? options[0].puts : undefined;
                const validPut1 = puts1 ? puts1.find(opt => opt.strike <= targetStrike) : undefined;
                
                const puts2 = Array.isArray(options) && options.length > 1 ? options[1].puts : undefined;
                const validPut2 = puts2 ? puts2.find(opt => opt.strike <= targetStrike) : undefined;
                
                let html = '';
                if (validPut1) {
                    const returnPct1 = (validPut1.lastPrice / price) * 100;
                    html += `<span class="font-mono text-gray-700">${returnPct1.toFixed(2)}%</span>`;
                } else {
                    html += '<span class="text-gray-400">—</span>';
                }
                
                html += ' / ';
                
                if (validPut2) {
                    const returnPct2 = (validPut2.lastPrice / price) * 100;
                    html += `<span class="font-mono text-gray-700">${returnPct2.toFixed(2)}%</span>`;
                } else {
                    html += '<span class="text-gray-400">—</span>';
                }
                
                cell.innerHTML = html;
            } catch (e) {
                cell.innerHTML = '<span class="text-gray-400">Error</span>';
            }
        }

        async function checkPutOptions(results, maxConcurrent = 2) {
            const optionsApiUrl = 'https://stockquote.lionelschiepers.synology.me/api/yahoo-finance-stock-options?ticker={TICKER}&filter=puts&limit=8&expirationDatesCount=2';
            
            results.forEach(r => {
                const cell = document.querySelector(`.put-option-cell[data-symbol="${r.Symbol}"]`);
                if (cell) cell.innerHTML = '<span class="text-gray-400">Loading...</span>';
            });
            
            for (let i = 0; i < results.length; i += maxConcurrent) {
                const batch = results.slice(i, i + maxConcurrent);
                await Promise.all(batch.map(r => checkSinglePutOption(r, optionsApiUrl)));
                if (i + maxConcurrent < results.length) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
        }
    </script>
</body>
</html>
